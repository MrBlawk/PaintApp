<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector painting app</title>


    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <!-- Importing font awesome for easy access to vector icons for buttons -->
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <button type="button" class="collapsible">Menu</button>
    <div class="content">
        <div id="menubar">
            <div class="colorButtons">
                <h5>Colors</h5>
                <input type="color" value="#000000" id="pencilColorSelector" class="colorSelector">
            </div>

            <div class="colorButtons">
                <h5>Background color</h5>
                <input type="color" value="#dee1d1" id="backgroundColorSelector" class="colorSelector">
            </div>

            <div class="pencilSize">
                <h6>Pencil size <span id="pencilSize">1</span></h6>
                <input type="range" id="pencilSizeSlider" min="1" max="20" value="1" step="1">
            </div>

            <div class="functions">
                <button id="eraserButton"><i class="fas fa-eraser"></i></button>
                <button id="undoButton"><i class="fas fa-rotate-left"></i><h6>Undo last</h6></button>
                <button id="resetButton">Reset</button>
            </div>



            <div class="functions">
                <h6>Create shapes & Import JSON</h6>
                <button id="importButton"><i class="fas fa-file-import"></i><h6>Import JSON</h6></button>
                <div class="dropdown">
                    <button class="btn border-dark btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa-solid fa-shapes"></i>
                        <h6>Shapes</h6>
                    </button>
                    <ul class="dropdown-menu">
                      <ol id="shape-line"><i class="fa-solid fa-grip-lines"></i> Line</ol>
                      <ol id="shape-square"><i class="fa-solid fa-square"></i> Square</ol>
                      <ol id="shape-circle"><i class="fa-solid fa-circle"></i> Circle</ol>
                      <ol id="shape-triangle"><i class="fa-solid fa-play"></i> Triangle</ol>
                      <ol id="shape-heart"><i class="fa-solid fa-heart"></i> Heart</ol>
                    </ul>
                </div>
            </div>

            <div class="pencilSize">
                <h6>Rotation degrees: <span id="rotationAmountId">0</span></h6>
                <input type="range" id="rotationAmountSlider" min="0" max="360" value="0" step="1">
            </div>

            <div class="functions">
                <p>X-Axis offset</p>
                <input type="number" step="1" id="x-axis">
                <p>Y-Axis offset</p>
                <input type="number" step="1" id="y-axis">
            </div>

            <div class="functions">
                <h6>Download</h6>
                <button id="downloadButton"><i class="fa-solid fa-download"></i></button>
            </div>


        </div>
    </div>
    


    <script>

        // Setting variables
        var mouseDown = false;
        var eraseEnabled = false;
        var lineEnabled = false;
        var canvas = document.createElement("canvas");
        var body = document.getElementsByTagName("body")[0];
        var sizeSlider = document.getElementById("pencilSize");
        var ctx = canvas.getContext('2d');

        //array for tracking line tracing coordinates
        let coords = [];

        //array for tracking all created shapes
        let shapes = [];
        
        currentSize = 5;
        lastSize = 5; 

        xAxisOffset = 0;
        yAxisOffset = 0; 
        var rotationAmount;

        var currentColor = "#000000";
        var lastColor;
        var currentBackground = "#dee1d1";

        //world coordinate variables
        var worldScale = 1;
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;

        const point = {
            x: centerX,
            y: centerY
        }

        //stroke ID
        let count = 0;


        //UI collapsing feature
        var coll = document.getElementsByClassName("collapsible");

        for (var i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var content = this.nextElementSibling;
            if (content.style.display === "block") {
            content.style.display = "none";
            } else {
            content.style.display = "block";
            }
        });
        }

        // Initialize drawing canvas
        createCanvas();

        // Button events //

        //Color picker
        document.getElementById("pencilColorSelector").addEventListener('change',
            function() {
                currentColor = this.value;
            }
        );

        //Background color picker
        document.getElementById("backgroundColorSelector").addEventListener('change',
            function() {
                currentBackground = this.value;
                createCanvas();
            }
        );

        //Pencil size
        document.getElementById("pencilSizeSlider").addEventListener('change',
            function(){
                currentSize = this.value;
                sizeSlider.innerHTML = currentSize;
            }
        );

        document.getElementById("rotationAmountSlider").addEventListener('change',
            function(){
                rotationAmount = this.value;
                rotationAmountId.innerHTML = this.value;   
                console.log(this.value)
            }
        )

        //x and y axis import offsets
        document.getElementById("x-axis").addEventListener('change',
            function(){
                xAxisOffset = this.value;
                console.log(this.value);
            }
        )

        document.getElementById("y-axis").addEventListener('change',
            function(){
                yAxisOffset = this.value;
                console.log(this.value);
            }
        )


        //download the canvas
        document.getElementById("downloadButton").addEventListener('click', function(){
            downloadCanvas(this, "canvas", "canvas.png");
        }, false);

        //Erase button 
        document.getElementById("eraserButton").addEventListener('click', erase);

        //reset canvas button
        document.getElementById("resetButton").addEventListener('click', createCanvas);

        document.getElementById("undoButton").addEventListener('click', undoLast);
        
        //importing button
        document.getElementById("importButton").addEventListener('click', importFile)

        //create shapes buttons
        //line
        document.getElementById("shape-line").addEventListener('click',
            function(){
                if(!lineEnabled){
                    lineEnabled = true;
                    document.getElementById("shape-line").style.backgroundColor = "#8f8f8f"
                }
                else{
                    lineEnabled = false;
                    document.getElementById("shape-line").style.backgroundColor = "#fff"
                }
            });
        //square
        document.getElementById("shape-square").addEventListener('click', 
            function(){
                let newSquare = new Square();
                newSquare.draw();
                shapes.push(newSquare);
        });
        //circle
        document.getElementById("shape-circle").addEventListener('click', 
            function(){
                let newCircle = new Circle();
                newCircle.draw();
                shapes.push(newCircle);
        });
        //triangle
        document.getElementById("shape-triangle").addEventListener('click', 
            function(){
                let newTriangle = new Triangle();
                newTriangle.draw();
                shapes.push(newTriangle);
        });
        //heart
        document.getElementById("shape-heart").addEventListener('click', 
            function(){
                let newHeart = new Heart();
                newHeart.draw();
                shapes.push(newHeart);
        });

        //Mouse event handlers
        //get coords from mouse to draw line
        canvas.addEventListener('click', function(){
            drawLine(event);
        });


        //Create canvas
        function createCanvas(){
            //reset the array
            linesArray = [];

            canvas.id = "canvas";
			canvas.width = parseInt(window.innerWidth * 0.9);
			canvas.height = parseInt(window.innerHeight * 0.9);

            canvas.style.border = "1px";
            canvas.style.zIndex = 8;
			canvas.style.position = "absolute";

            ctx.fillStyle = currentBackground;
            ctx.fillRect(0, 0, point.x * 2, point.y * 2);

            body.appendChild(canvas);

            //fix coordinates of canvas to world coordinates
            ctx.translate(centerX, centerY);
        }

        //Erase function, fills everything with current set background color
        function erase(btn){
            if(!eraseEnabled){
                eraseEnabled = true;
                lastSize = currentSize;
                lastColor = currentColor;
                currentSize = 50;
                currentColor = ctx.fillStyle;
                document.getElementById("eraserButton").style.backgroundColor = "#8f8f8f"
            }
            else{
                eraseEnabled = false;
                currentSize = lastSize;
                currentColor = lastColor;
                document.getElementById("eraserButton").style.backgroundColor = "#fff"
            }
        }

        //Get mouse position
        function getMousePos(canvas, evt){
            var rect = canvas.getBoundingClientRect();
            return{
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }



        //Store data DEPRECATED
        // function store(x, y, s, c, n){
        //     var line = {
        //         "x": x,
        //         "y": y,
        //         "size": s,
        //         "color": c,
        //         "ID": n
        //     }
        //     linesArray.push(line);
        // }


        //converting window raster to world coordinates
        function convert(coords) {
            const x = (coords.x - centerX) / worldScale;
            const y = (coords.y - centerY) / worldScale;
            return { 
                x: x, 
                y: y
            };
        }

        //idea of a function to scale json coordinates according to screen size
        function scale(coords){
            let x = (coords.x * currentSize) + parseInt(xAxisOffset); //adjusted so 0,0 is center of screen.
            let y = (coords.y * currentSize) + parseInt(yAxisOffset * -1); //adjusted to flip y coords, offset makes sure 0,0 is center of screen
            return {
                x: x,
                y: y
            };
        }

        //inheritance concept
        class Shape {
            constructor(type){
                this.shapename = type;

                // This became unnecessary after Raymond his example.. but why?
                // ctx.lineWidth = currentSize;
                // ctx.strokeStyle = currentColor;
                // ctx.fillStyle = currentColor
                console.log(shapes);
            }

            present(type){
                console.log("drawing shape: " + this.type);
            }

            draw(){};
            
        }

        class Square extends Shape {
            constructor (type){
                super(type);
                this.shapename = "Square";
            }

            draw(){
                ctx.save();
                ctx.lineWidth = currentSize;
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor
                ctx.rotate(rotationAmount * Math.PI / 180);
                ctx.beginPath();
                ctx.rect(xAxisOffset, yAxisOffset, currentSize * 10, currentSize * 10);
                ctx.stroke();
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        class Circle extends Shape {
            constructor(type){
                super(type);
                this.type = "Circle";

            }

            draw(){
                ctx.save();
                ctx.lineWidth = currentSize;
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor
                ctx.beginPath();
                ctx.arc(xAxisOffset, yAxisOffset, currentSize * 10, 0, 2* Math.PI);
                ctx.stroke();
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        class Triangle extends Shape {
            constructor(type){
                super(type);
                this.type = "Triangle";

            }

            draw(){
                ctx.save();

                ctx.lineWidth = currentSize;
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor
                ctx.beginPath();
                ctx.moveTo(0, 0 );
                ctx.lineTo((20 * currentSize), (20 * currentSize));
                ctx.lineTo((-20 * currentSize), (20 * currentSize));
                ctx.lineTo(0 , 0 );
                ctx.stroke();
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        class Heart extends Shape {
            constructor(type){
                super(type);
                this.type = "Heart";

            }

            draw(){
                ctx.save();

                ctx.lineWidth = currentSize;
                ctx.strokeStyle = currentColor;
                ctx.fillStyle = currentColor
                ctx.beginPath();
                
                var width = 20 * currentSize;
                var height = 20 * currentSize;
                var x = 0, y = 0;
                var topCurveHeight = height * 0.3;
                ctx.moveTo(x, y + topCurveHeight);
                // top left curve
                ctx.bezierCurveTo(
                    x, y, 
                    x - width / 2, y, 
                    x - width / 2, y + topCurveHeight
                );

                // bottom left curve
                ctx.bezierCurveTo(
                    x - width / 2, y + (height + topCurveHeight) / 2, 
                    x, y + (height + topCurveHeight) / 2, 
                    x, y + height
                );

                // bottom right curve
                ctx.bezierCurveTo(
                    x, y + (height + topCurveHeight) / 2, 
                    x + width / 2, y + (height + topCurveHeight) / 2, 
                    x + width / 2, y + topCurveHeight
                );

                // top right curve
                ctx.bezierCurveTo(
                    x + width / 2, y, 
                    x, y, 
                    x, y + topCurveHeight
                );


                ctx.stroke();
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
        }

        //function for tracing two coordinates and drawing a line in between
        function drawLine(event){
            console.log("Clicked canvas.");
        
            if(lineEnabled){
                var coord = {"x": event.x, "y": event.y};
                coords.push(convert(getMousePos(canvas, event)));
                var max = coords.length -1;
                if(typeof coords[max - 1] !== "undefined"){
                    ctx.beginPath();
                    ctx.lineWidth = currentSize;
                    ctx.strokeStyle = currentColor;
                    ctx.lineCap = "round";
                    ctx.moveTo(coords[max].x, coords[max].y);
                    ctx.lineTo(coords[max - 1].x, coords[max - 1].y);
                    ctx.stroke();  	
                };
            }
            else if(!lineEnabled){
                coords = [];
            }
        }

        //function to import shapes in json format, based on x and y coords
        async function importFile(){
            //fetch the test file
            const response = await fetch("test.json");
            const obj = await response.json();
            
            //save current state in order to restore after rotation is applied, helps to recover mouse to canvas coord tracking
            ctx.save();
            //rotation will be applied if slider is set to anything other than 0.
            ctx.rotate(rotationAmount * Math.PI / 180);
            ctx.beginPath();
            for(var i in obj){
                const coords = scale(obj[i]);
                ctx.lineTo(coords.x, coords.y);
                store(coords.x, coords.y, 1, currentColor);
            }
            ctx.closePath();
            ctx.fillStyle = currentColor;
            ctx.fill();
            ctx.fillStyle = currentBackground;
            ctx.restore();
        }


        let r = new Square()
        let c = new Circle()

        r.draw();
        c.draw();


        shapes = [r,c, new Circle()]

        //wat doet dit?
        function draw (s) {
            s.draw();
        }
        //objects.map(draw)


        //work in progress
        function undoLast(){
            shapes.pop();
            createCanvas();
            console.log(shapes);
            shapes.map(draw);
        }

        //saving function

		function save() {
			localStorage.removeItem("savedCanvas");
			localStorage.setItem("savedCanvas", JSON.stringify(linesArray));
			console.log("Saved canvas!");
		}

        //loading from localstorage

		function load() {
			if (localStorage.getItem("savedCanvas") != null) {
				linesArray = JSON.parse(localStorage.savedCanvas);
				var lines = JSON.parse(localStorage.getItem("savedCanvas"));
				for (var i = 1; i < lines.length; i++) {
					ctx.beginPath();
					ctx.moveTo(linesArray[i-1].x, linesArray[i-1].y);
					ctx.lineWidth  = linesArray[i].size;
					ctx.lineCap = "round";
					ctx.strokeStyle = linesArray[i].color;
					ctx.lineTo(linesArray[i].x, linesArray[i].y);
					ctx.stroke();
				}
				console.log("Canvas loaded.");
			}
			else {
				console.log("No canvas in memory!");
			}
		}

        //download the canvas
		function downloadCanvas(link, canvas, filename) {
            save();
			link.href = document.getElementById(canvas).toDataURL();
			link.download = filename;
		}
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
</body>
</html>