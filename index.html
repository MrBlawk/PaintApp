<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector painting app</title>


    <link rel="stylesheet" href="styles.css">
    <!-- Importing font awesome for easy access to vector icons for buttons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <button type="button" class="collapsible">Menu</button>
<div class="content">
    <div id="menubar">
        <div class="colorButtons">
            <h4>Colors</h4>
            <input type="color" value="#000000" id="pencilColorSelector" class="colorSelector">
        </div>

        <div class="colorButtons">
            <h4>Background color (refresh)</h4>
            <input type="color" value="#8f8f8f" id="backgroundColorSelector" class="colorSelector">
        </div>

        <div class="pencilSize">
            <h4>Pencil size <span id="pencilSize">1</span></h4>
            <input type="range" id="pencilSizeSlider" min="1" max="20" value="1" step="1">
        </div>

        <div class="functions">
            <button id="eraserButton"><i class="fas fa-eraser"></i></button>
            <button id="undoButton"><i class="fas fa-rotate-left"></i></button>
        </div>

        <div class="functions">
            <h4>Import SVG</h4>
            <button id="importButton"><i class="fas fa-file-import"></i></button>

        </div>
    </div>
</div>
    


    <script>
        //UI collapsing feature
        var coll = document.getElementsByClassName("collapsible");

        for (var i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
            this.classList.toggle("active");
            var content = this.nextElementSibling;
            if (content.style.display === "block") {
            content.style.display = "none";
            } else {
            content.style.display = "block";
            }
        });
        }




        // Setting variables
        var mouseDown = false;
        var eraseEnabled = false;
        var canvas = document.createElement("canvas");
        var body = document.getElementsByTagName("body")[0];
        var sizeSlider = document.getElementById("pencilSize");
        var ctx = canvas.getContext('2d');
        
        var linesArray = [];
        currentSize = 5;
        lastSize = 5; 
        var currentColor = "#000000";
        var lastColor;
        var currentBackground = "#8f8f8f";

        //world coordinate variables
        var worldScale = 1;
        const centerX = window.innerWidth /2;
        const centerY = window.innerHeight /2;

        const circle = {
            x: 350,
            y: -210,
            radius: 247
        }

        const point = {
            x: centerX,
            y: centerY
        }

        

        // Initialize drawing canvas
        createCanvas();

        // Button events

        //Color picker
        document.getElementById("pencilColorSelector").addEventListener('change',
            function() {
                currentColor = this.value;
            }
        );

        //Background color picker
        document.getElementById("backgroundColorSelector").addEventListener('change',
            function() {
                currentBackground = this.value;
            }
        );

        //Pencil size
        document.getElementById("pencilSizeSlider").addEventListener('change',
            function(){
                currentSize = this.value;
                sizeSlider.innerHTML = currentSize;
                console.log(currentSize);
            }
        );

        //Erase button 
        document.getElementById("eraserButton").addEventListener('click', erase);

        //Undo all button
        document.getElementById("undoButton").addEventListener('click', createCanvas);
        
        //importing button
        document.getElementById("importButton").addEventListener('click', importFile)

        //Mouse event handlers
        canvas.addEventListener('mousedown',
            function(){
                mousedown(canvas, event);
            }
        );

        canvas.addEventListener('mousemove',
            function(){
                mousemove(canvas, event);
            }
        );

        canvas.addEventListener('mouseup', mouseup);


        //Create canvas
        function createCanvas(){
            canvas.id = "canvas";
			canvas.width = parseInt(window.innerWidth - (window.innerWidth * 0.2));
			canvas.height = parseInt(window.innerHeight - (window.innerHeight * 0.2));

            canvas.style.border = "1px";
            canvas.style.zIndex = 8;
			canvas.style.position = "absolute";

            ctx.fillStyle = currentBackground;
            ctx.fillRect(0, 0, point.x * 2, point.y * 2);

            body.appendChild(canvas);

            //fix coordinates of canvas to world coordinates
            ctx.translate(centerX, centerY);
        }

        //Erase function
        function erase(btn){
            if(!eraseEnabled){
                eraseEnabled = true;
                lastSize = currentSize;
                lastColor = currentColor;
                currentSize = 50;
                currentColor = ctx.fillStyle;
                document.getElementById("eraserButton").style.backgroundColor = "#8f8f8f"
            }
            else{
                eraseEnabled = false;
                currentSize = lastSize;
                currentColor = lastColor;
                document.getElementById("eraserButton").style.backgroundColor = "#fff"
            }

        }

        //Get mouse position
        function getMousePos(canvas, evt){
            var rect = canvas.getBoundingClientRect();
            return{
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }

        //On mouse down
        function mousedown(canvas, evt){
			mouseDown = true;
			var currentPosition = convert(getMousePos(canvas, evt));
			ctx.moveTo(currentPosition.x, currentPosition.y)
			ctx.beginPath();
			ctx.lineWidth  = currentSize;
			ctx.lineCap = "round";
			ctx.strokeStyle = currentColor;
        };

        // On mouse move
		function mousemove(canvas, evt) {
            if(mouseDown){
            var currentPosition = convert(getMousePos(canvas, evt));
            ctx.lineTo(currentPosition.x, currentPosition.y)
            ctx.stroke();
            store(currentPosition.x, currentPosition.y, currentSize, currentColor);
            }
        }

        //Store data
        function store(x, y, s, c){
            var line = {
                "x": x,
                "y": y,
                "size": s,
                "color": c
            }
            linesArray.push(line);
        }

        async function importFile(){
            const response = await fetch("test.json");
            const obj = await response.json();
            ctx.beginPath();
            for(var i in obj){
                ctx.lineTo(obj[i].x, obj[i].y);
            }
            ctx.closePath();
            ctx.fillStyle = "#ffffff";
            ctx.fill();
            ctx.fillStyle = currentBackground;
        }


        //On mouse up
        function mouseup(){
            mouseDown = false;
            store();
        }

        function convert(coords) {
            const x = (coords.x - centerX) / worldScale;
            const y = (coords.y - centerY) / worldScale;
            console.log("X = " + x + " & Y = " + y);
            return { 
                x: x, 
                y: y 
            };

        }

    </script>
</body>
</html>